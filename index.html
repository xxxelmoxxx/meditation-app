<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>å‘¼å¸ç‘æƒ³ã‚¢ãƒ—ãƒª</title>

<link rel="icon" href="favicon.png" type="image/png">
<link rel="apple-touch-icon" href="favicon.png">

<style>
  :root{
    /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆæœ€åˆã«é©ç”¨ã•ã‚Œã‚‹ãƒ†ãƒ¼ãƒï¼‰ */
    --bg1:#667eea;
    --bg2:#764ba2;
    --card: rgba(255,255,255,.15);
    --text: #ffffff;
    --muted: rgba(255,255,255,.88);

    --accent:#38bdf8;
    --accent2:#a78bfa;

    /* ãƒœã‚¿ãƒ³ã¯å…±é€šï¼ˆå¢—æ®–ã‚’é¿ã‘ã‚‹ï¼‰ */
    --start1:#22c55e;
    --start2:#16a34a;
    --stop1:#6b7280;
    --stop2:#4b5563;

    --shadow: rgba(0,0,0,.30);
    --radius: 20px;
  }

  body{
    font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    background: linear-gradient(135deg, var(--bg1), var(--bg2));
    color: var(--text);
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
    margin:0;
    padding: 16px;
    box-sizing:border-box;
  }

  .container{
    width: 390px;
    background: var(--card);
    padding: 18px 18px 20px;
    border-radius: var(--radius);
    box-shadow: 0 10px 30px var(--shadow);
    backdrop-filter: blur(10px);
  }

  h1{
    text-align:center;
    margin: 0 0 10px 0;
    font-size: 20px;
  }

  .row{
    display:flex;
    gap: 10px;
    align-items:center;
    justify-content:space-between;
    margin: 6px 0;
  }

  label{
    font-size: 13px;
    color: var(--muted);
    white-space: nowrap;
  }

  select{
    width: 64%;
    padding: 7px 10px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,.25);
    background: rgba(0,0,0,.15);
    color: var(--text);
    outline: none;
  }

  .divider{
    height: 1px;
    background: rgba(255,255,255,.18);
    margin: 10px 0;
  }

  /* å¸ã†/åãã‚’ã€Œè¡Œæ•°è©°ã‚ã€ */
  .ranges{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 6px;
  }
  .rangeBox{
    display:flex;
    flex-direction:column;
    gap: 4px;
  }
  .lineLabel{
    display:flex;
    justify-content:space-between;
    align-items:baseline;
    gap: 10px;
    font-size: 13px;
    color: var(--muted);
    line-height: 1.1;
  }
  .lineLabel .val{
    color: var(--accent);
    font-weight: 800;
  }

  input[type=range]{
    width:100%;
    height: 6px;
    border-radius: 3px;
    background: rgba(255,255,255,.28);
    outline:none;
    -webkit-appearance:none;
  }
  input[type=range]::-webkit-slider-thumb{
    -webkit-appearance:none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
  }

  audio{
    width:100%;
    margin-top: 10px;
    border-radius: 10px;
  }

  .note{
    font-size: 12px;
    color: var(--muted);
    line-height: 1.35;
    text-align:center;
    margin-top: 6px;
  }

  /* å††ã‚¨ãƒªã‚¢ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢åˆ†é›¢ï¼ˆè¢«ã‚Šé˜²æ­¢ï¼‰ */
  .visual{
    margin-top: 10px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap: 8px;
  }

  .circleWrap{
    width: 100%;
    height: 240px;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow: hidden;
  }

  #circle{
    position: relative;
    width: 170px;
    height: 170px;
    border-radius: 50%;
    background: var(--accent);
    box-shadow: 0 0 42px rgba(0,0,0,.10);
    transform: scale(1);
    opacity: .92;
    transition-property: transform, opacity;
    transition-timing-function: linear;
  }

  #countdown{
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 48px;
    font-weight: 800;
    color: #ffffff;
    opacity: 0.92;
    pointer-events: none;
    user-select: none;
    text-shadow: 0 2px 10px rgba(0,0,0,.25);
  }

  #instruction{
    text-align:center;
    font-size: 20px;
    min-height: 30px;
    font-weight: 700;
  }

  #duration{
    display:none;
    font-weight: 800;
    color: var(--text);
    opacity: .92;
  }

  .controls{
    margin-top: 14px;
    display:flex;
    justify-content:space-between;
    gap: 12px;
  }

  button{
    width: 50%;
    padding: 12px;
    border: none;
    border-radius: 24px;
    font-size: 16px;
    cursor: pointer;
    color: white;
    transition: transform .15s ease;
  }
  button:hover{ transform: scale(1.03); }

  #start{
    background: linear-gradient(45deg, var(--start1), var(--start2));
  }
  #stop{
    background: linear-gradient(45deg, var(--stop1), var(--stop2));
  }
</style>
</head>

<body>
  <div class="container">
    <h1>å‘¼å¸ç‘æƒ³ã‚¢ãƒ—ãƒª</h1>

    <!-- ãƒ†ãƒ¼ãƒï¼ˆ1å›é¸æŠï¼‰ -->
    <div class="row">
      <label for="themeSelect">ãƒ†ãƒ¼ãƒ</label>
      <select id="themeSelect"></select>
    </div>

    <div class="divider"></div>

    <!-- ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ  -->
    <div class="row">
      <label for="metroOn">ç§’ã‚«ã‚¦ãƒ³ãƒˆï¼ˆãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ ï¼‰</label>
      <input id="metroOn" type="checkbox" checked />
    </div>

    <div class="divider"></div>

    <!-- å¸ã†/åã -->
    <div class="ranges">
      <div class="rangeBox">
        <div class="lineLabel">
          <span>å¸ã†ï¼ˆç§’ï¼‰</span>
          <span class="val" id="inhaleVal">6ç§’</span>
        </div>
        <input id="inhale" type="range" min="2" max="10" value="6" />
      </div>

      <div class="rangeBox">
        <div class="lineLabel">
          <span>åãï¼ˆç§’ï¼‰</span>
          <span class="val" id="exhaleVal">8ç§’</span>
        </div>
        <input id="exhale" type="range" min="4" max="12" value="8" />
      </div>
    </div>

    <!-- BGMï¼ˆè‡ªå‹•ãƒ«ãƒ¼ãƒ—ï¼‰ -->
    <audio id="bgm" src="music/bgm.mp3" preload="auto" controls loop></audio>

    <div class="note">
      åˆå›³éŸ³ï¼šä½ã„éŸ³ï¼å¸ã†/åãã€€é«˜ã„éŸ³2å›ï¼æ¯ã‚’æ­¢ã‚ã‚‹ï¼ˆ2ç§’ï¼‰
    </div>
    <div class="note">
      BGMï¼šå„ªã—ã„ç¯ç« (Tenderly glow) / è’²é‰¾ã•ã¡ã“ï¼ˆDOVA-SYNDROMEï¼‰
    </div>

    <!-- ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ« -->
    <div class="visual">
      <div class="circleWrap">
        <div id="circle">
          <div id="countdown"></div>
        </div>
      </div>

      <div id="instruction">æº–å‚™ãŒã§ããŸã‚‰é–‹å§‹ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
      <div id="duration" class="note">ä»Šå›ã®ç‘æƒ³æ™‚é–“ï¼š00:00</div>

      <div id="lockNote" class="note" style="display:none;">
        è¨­å®šã¯åœæ­¢å¾Œã«å¤‰æ›´ã§ãã¾ã™
      </div>
    </div>

    <div class="controls">
      <button id="start">é–‹å§‹</button>
      <button id="stop">åœæ­¢</button>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  // ===== ãƒ†ãƒ¼ãƒå®šç¾©ï¼ˆã‚ãªãŸã®æç¤ºãƒ‡ãƒ¼ã‚¿ã‚’å†…è”µï¼‰
  const THEMES = [
    // 1) Calm / ç™’ã—
    { id:"calm_mist", label:"ç™’ã—ï¼šãƒŸã‚¹ãƒˆ", category:"Calm", vars:{
      "--bg1":"#BFE7F6","--bg2":"#D9C7FF","--card":"rgba(255,255,255,.18)","--text":"#0B1020",
      "--muted":"rgba(11,16,32,.75)","--accent":"#2DD4BF","--accent2":"#A78BFA"
    }},
    { id:"calm_sand", label:"ç™’ã—ï¼šã‚µãƒ³ãƒ‰", category:"Calm", vars:{
      "--bg1":"#F7E7CE","--bg2":"#F3D6D6","--card":"rgba(255,255,255,.20)","--text":"#1F2937",
      "--muted":"rgba(31,41,55,.72)","--accent":"#F59E0B","--accent2":"#FB7185"
    }},

    // 2) Fresh / çˆ½ã‚„ã‹
    { id:"fresh_aqua", label:"çˆ½ã‚„ã‹ï¼šã‚¢ã‚¯ã‚¢", category:"Fresh", vars:{
      "--bg1":"#7DD3FC","--bg2":"#A7F3D0","--card":"rgba(255,255,255,.16)","--text":"#06203A",
      "--muted":"rgba(6,32,58,.72)","--accent":"#0EA5E9","--accent2":"#10B981"
    }},
    { id:"fresh_ice", label:"çˆ½ã‚„ã‹ï¼šã‚¢ã‚¤ã‚¹", category:"Fresh", vars:{
      "--bg1":"#E0F2FE","--bg2":"#E5E7EB","--card":"rgba(255,255,255,.22)","--text":"#0F172A",
      "--muted":"rgba(15,23,42,.70)","--accent":"#38BDF8","--accent2":"#94A3B8"
    }},

    // 3) Trust / ä¿¡é ¼
    { id:"trust_navy", label:"ä¿¡é ¼ï¼šãƒã‚¤ãƒ“ãƒ¼", category:"Trust", vars:{
      "--bg1":"#0F172A","--bg2":"#1F2937","--card":"rgba(255,255,255,.08)","--text":"#F8FAFC",
      "--muted":"rgba(248,250,252,.78)","--accent":"#60A5FA","--accent2":"#94A3B8"
    }},
    { id:"trust_brick", label:"ä¿¡é ¼ï¼šãƒ–ãƒªãƒƒã‚¯", category:"Trust", vars:{
      "--bg1":"#111827","--bg2":"#374151","--card":"rgba(255,255,255,.09)","--text":"#F9FAFB",
      "--muted":"rgba(249,250,251,.76)","--accent":"#B45309","--accent2":"#93C5FD"
    }},

    // 4) Warm / ã‚ãŸãŸã‹ã„
    { id:"warm_sunset", label:"ã‚ãŸãŸã‹ã„ï¼šã‚µãƒ³ã‚»ãƒƒãƒˆ", category:"Warm", vars:{
      "--bg1":"#FB923C","--bg2":"#F472B6","--card":"rgba(255,255,255,.14)","--text":"#2A0A0A",
      "--muted":"rgba(42,10,10,.72)","--accent":"#F97316","--accent2":"#EC4899"
    }},
    { id:"warm_cocoa", label:"ã‚ãŸãŸã‹ã„ï¼šã‚³ã‚³ã‚¢", category:"Warm", vars:{
      "--bg1":"#A16207","--bg2":"#7C2D12","--card":"rgba(255,255,255,.10)","--text":"#FFF7ED",
      "--muted":"rgba(255,247,237,.78)","--accent":"#FBBF24","--accent2":"#FDBA74"
    }},

    // 5) Pop / å…ƒæ°—
    { id:"pop_candy", label:"å…ƒæ°—ï¼šã‚­ãƒ£ãƒ³ãƒ‡ã‚£", category:"Pop", vars:{
      "--bg1":"#22C55E","--bg2":"#06B6D4","--card":"rgba(255,255,255,.13)","--text":"#04130C",
      "--muted":"rgba(4,19,12,.70)","--accent":"#FDE047","--accent2":"#FB7185"
    }},
    { id:"pop_tropical", label:"å…ƒæ°—ï¼šãƒˆãƒ­ãƒ”ã‚«ãƒ«", category:"Pop", vars:{
      "--bg1":"#38BDF8","--bg2":"#F97316","--card":"rgba(255,255,255,.12)","--text":"#0B1220",
      "--muted":"rgba(11,18,32,.72)","--accent":"#A3E635","--accent2":"#F43F5E"
    }},

    // 6) Retro / ãƒ¬ãƒˆãƒ­
    { id:"retro_aqua_gold", label:"ãƒ¬ãƒˆãƒ­ï¼šã‚¢ã‚¯ã‚¢Ã—ã‚´ãƒ¼ãƒ«ãƒ‰", category:"Retro", vars:{
      "--bg1":"#67E8F9","--bg2":"#FDE68A","--card":"rgba(255,255,255,.18)","--text":"#1F2937",
      "--muted":"rgba(31,41,55,.72)","--accent":"#CA8A04","--accent2":"#0EA5E9"
    }},
    { id:"retro_olive", label:"ãƒ¬ãƒˆãƒ­ï¼šã‚ªãƒªãƒ¼ãƒ–", category:"Retro", vars:{
      "--bg1":"#A3A635","--bg2":"#0F766E","--card":"rgba(255,255,255,.10)","--text":"#F8FAFC",
      "--muted":"rgba(248,250,252,.78)","--accent":"#F59E0B","--accent2":"#EAB308"
    }},

    // 7) Nature / è‡ªç„¶
    { id:"nature_forest", label:"è‡ªç„¶ï¼šãƒ•ã‚©ãƒ¬ã‚¹ãƒˆ", category:"Nature", vars:{
      "--bg1":"#14532D","--bg2":"#0F766E","--card":"rgba(255,255,255,.09)","--text":"#ECFDF5",
      "--muted":"rgba(236,253,245,.78)","--accent":"#84CC16","--accent2":"#FDE047"
    }},
    { id:"nature_meadow", label:"è‡ªç„¶ï¼šãƒ¡ãƒ‰ã‚¦", category:"Nature", vars:{
      "--bg1":"#A7F3D0","--bg2":"#BBF7D0","--card":"rgba(255,255,255,.20)","--text":"#052016",
      "--muted":"rgba(5,32,22,.70)","--accent":"#22C55E","--accent2":"#10B981"
    }},

    // 8) Night / å¤œ
    { id:"night_indigo", label:"å¤œï¼šã‚¤ãƒ³ãƒ‡ã‚£ã‚´", category:"Night", vars:{
      "--bg1":"#111827","--bg2":"#312E81","--card":"rgba(255,255,255,.08)","--text":"#F8FAFC",
      "--muted":"rgba(248,250,252,.76)","--accent":"#A78BFA","--accent2":"#38BDF8"
    }},
    { id:"night_aurora", label:"å¤œï¼šã‚ªãƒ¼ãƒ­ãƒ©", category:"Night", vars:{
      "--bg1":"#020617","--bg2":"#064E3B","--card":"rgba(255,255,255,.07)","--text":"#E2E8F0",
      "--muted":"rgba(226,232,240,.75)","--accent":"#2DD4BF","--accent2":"#84CC16"
    }},

    // 9) Mono / ãƒ¢ãƒãƒˆãƒ¼ãƒ³
    { id:"mono_light", label:"ãƒ¢ãƒï¼šãƒ©ã‚¤ãƒˆ", category:"Mono", vars:{
      "--bg1":"#F8FAFC","--bg2":"#E5E7EB","--card":"rgba(0,0,0,.06)","--text":"#0F172A",
      "--muted":"rgba(15,23,42,.70)","--accent":"#111827","--accent2":"#64748B"
    }},
    { id:"mono_dark", label:"ãƒ¢ãƒï¼šãƒ€ãƒ¼ã‚¯", category:"Mono", vars:{
      "--bg1":"#0B1020","--bg2":"#111827","--card":"rgba(255,255,255,.08)","--text":"#F1F5F9",
      "--muted":"rgba(241,245,249,.76)","--accent":"#E5E7EB","--accent2":"#94A3B8"
    }},

    // 10) Pastel / ãƒ‘ã‚¹ãƒ†ãƒ«
    { id:"pastel_sakura", label:"ãƒ‘ã‚¹ãƒ†ãƒ«ï¼šã•ãã‚‰", category:"Pastel", vars:{
      "--bg1":"#FBCFE8","--bg2":"#E9D5FF","--card":"rgba(255,255,255,.22)","--text":"#1F2937",
      "--muted":"rgba(31,41,55,.70)","--accent":"#FB7185","--accent2":"#A78BFA"
    }},
    { id:"pastel_lemon", label:"ãƒ‘ã‚¹ãƒ†ãƒ«ï¼šãƒ¬ãƒ¢ãƒ³", category:"Pastel", vars:{
      "--bg1":"#FEF9C3","--bg2":"#CFFAFE","--card":"rgba(255,255,255,.22)","--text":"#1F2937",
      "--muted":"rgba(31,41,55,.70)","--accent":"#EAB308","--accent2":"#06B6D4"
    }},
  ];

  function applyTheme(themeId){
    const theme = THEMES.find(t => t.id === themeId);
    if (!theme) return;
    const root = document.documentElement;
    Object.entries(theme.vars).forEach(([k,v]) => root.style.setProperty(k, v));
  }

  function pickRandomTheme() {
    const index = Math.floor(Math.random() * THEMES.length);
    return THEMES[index];
  }

  // ===== DOM
  const inhale = document.getElementById("inhale");
  const exhale = document.getElementById("exhale");
  const inhaleVal = document.getElementById("inhaleVal");
  const exhaleVal = document.getElementById("exhaleVal");
  const circle = document.getElementById("circle");
  const countdown = document.getElementById("countdown");
  const instruction = document.getElementById("instruction");
  const lockNote = document.getElementById("lockNote");
  const durationEl = document.getElementById("duration");
  const bgm = document.getElementById("bgm");

  const themeSelect = document.getElementById("themeSelect");
  const metroOn = document.getElementById("metroOn");

  // ===== ãƒ†ãƒ¼ãƒãƒ—ãƒ«ãƒ€ã‚¦ãƒ³
  function buildThemeSelect(){
    const byCat = new Map();
    THEMES.forEach(t => {
      if (!byCat.has(t.category)) byCat.set(t.category, []);
      byCat.get(t.category).push(t);
    });
  
    themeSelect.innerHTML = "";
  
    // â˜… ãƒ©ãƒ³ãƒ€ãƒ è¿½åŠ ï¼ˆæœ€ä¸Šæ®µï¼‰
    const randomOpt = document.createElement("option");
    randomOpt.value = "random";
    randomOpt.textContent = "ğŸ² ãƒ©ãƒ³ãƒ€ãƒ ";
    themeSelect.appendChild(randomOpt);
  
    Array.from(byCat.keys()).forEach(cat => {
      const og = document.createElement("optgroup");
      og.label = cat;
      byCat.get(cat).forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.label;
        og.appendChild(opt);
      });
      themeSelect.appendChild(og);
    });
  }

  buildThemeSelect();

  const THEME_KEY = "breathing_theme_id";
  const savedTheme = localStorage.getItem(THEME_KEY);
  const initialTheme = savedTheme && THEMES.some(t => t.id === savedTheme)
    ? savedTheme
    : "calm_mist"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆå¥½ã¿ã§å¤‰æ›´OKï¼‰

  themeSelect.value = initialTheme;
  applyTheme(initialTheme);

  themeSelect.addEventListener("change", () => {
    localStorage.setItem(THEME_KEY, themeSelect.value);
    applyTheme(themeSelect.value);
  });

  // ===== UIãƒ­ãƒƒã‚¯
  function setControlsEnabled(enabled){
    const controls = [themeSelect, metroOn, inhale, exhale];
    controls.forEach(el => { el.disabled = !enabled; });

    const opacity = enabled ? "1" : "0.6";
    controls.forEach(el => {
      el.style.opacity = opacity;
      el.style.cursor = enabled ? "pointer" : "not-allowed";
    });
  }

  // ===== ç§’æ•°è¡¨ç¤º
  function updateValues(){
    inhaleVal.textContent = inhale.value + "ç§’";
    exhaleVal.textContent = exhale.value + "ç§’";
  }
  inhale.addEventListener("input", updateValues);
  exhale.addEventListener("input", updateValues);
  updateValues();

  // ===== ãƒ­ã‚°ï¼ˆãƒ“ãƒ¼ã‚³ãƒ³GETï¼‰
  const LOG_ENDPOINT = "ï¼ˆã‚ãªãŸã®/exec URLã«ç½®ãæ›ãˆï¼‰";

  function getClientId() {
    const key = "breathing_client_id";
    let id = localStorage.getItem(key);
    if (!id) {
      id = (window.crypto && crypto.randomUUID)
        ? crypto.randomUUID()
        : ("id_" + Math.random().toString(36).slice(2) + Date.now().toString(36));
      localStorage.setItem(key, id);
    }
    return id;
  }

  function logUsageToSheet(action) {
    // URLæœªè¨­å®šãªã‚‰ä½•ã‚‚ã—ãªã„ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç¢ºèªç”¨ï¼‰
    if (!LOG_ENDPOINT || LOG_ENDPOINT.includes("ç½®ãæ›ãˆ")) return;

    const url = new URL(LOG_ENDPOINT);
    url.searchParams.set("action", action);
    url.searchParams.set("inhale", inhale.value);
    url.searchParams.set("exhale", exhale.value);
    url.searchParams.set("clientId", getClientId());
    url.searchParams.set("userAgent", navigator.userAgent);
    url.searchParams.set("referrer", document.referrer || "");
    url.searchParams.set("t", String(Date.now()));

    // startæ™‚ã ã‘ãƒ†ãƒ¼ãƒ/metroã‚’é€ã‚‹
    if (action === "start") {
      url.searchParams.set("theme", themeSelect.value);              // themeId
      url.searchParams.set("metroOn", metroOn.checked ? "1" : "0");
    } else {
      url.searchParams.set("theme", "");
      url.searchParams.set("metroOn", "");
    }

    const img = new Image();
    img.src = url.toString();
  }

  // ===== éŸ³ï¼ˆåˆå›³ï¼‹ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ ï¼‰
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  function ensureAudio(){
    if (audioCtx.state === "suspended") {
      audioCtx.resume().catch(()=>{});
    }
  }

  // åˆå›³éŸ³ï¼ˆæœ¨ã£ã½ã„ã‚³ãƒ„ï¼‰
  function wood(freq = 300, duration = 0.11, gainPeak = 0.35){
    ensureAudio();
    const now = audioCtx.currentTime;

    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    const filter = audioCtx.createBiquadFilter();

    osc.type = "square";
    osc.frequency.value = freq;

    filter.type = "bandpass";
    filter.frequency.value = Math.min(2400, freq * 3);

    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(gainPeak, now + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, now + duration);

    osc.connect(filter);
    filter.connect(g);
    g.connect(audioCtx.destination);

    osc.start(now);
    osc.stop(now + duration);
  }

  // ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ ï¼ˆãƒã‚¤ã‚ºã‚¯ãƒªãƒƒã‚¯ï¼‰
  function metroClick(accent = false){
    ensureAudio();
    const now = audioCtx.currentTime;

    const bufferSize = Math.floor(audioCtx.sampleRate * 0.03);
    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;

    const noise = audioCtx.createBufferSource();
    noise.buffer = buffer;

    const gain = audioCtx.createGain();
    const filter = audioCtx.createBiquadFilter();

    filter.type = "highpass";
    filter.frequency.value = 2800;

    const peak = accent ? 0.08 : 0.05;

    gain.gain.setValueAtTime(0.0001, now);
    gain.gain.exponentialRampToValueAtTime(peak, now + 0.005);
    gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.03);

    noise.connect(filter);
    filter.connect(gain);
    gain.connect(audioCtx.destination);

    noise.start(now);
    noise.stop(now + 0.04);
  }

  let metroTimer = null;
  function startMetronome(){
    stopMetronome();
    if (!metroOn.checked) return;
    metroClick(true);
    metroTimer = setInterval(() => metroClick(false), 1000);
  }
  function stopMetronome(){
    if (metroTimer) {
      clearInterval(metroTimer);
      metroTimer = null;
    }
  }

  // ===== å‘¼å¸ãƒ•ã‚§ãƒ¼ã‚º
  let running = false;
  let timer = null;

  const HOLD_MS = 2000;

  // å††ã®ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆè¢«ã‚Šã«ãã•å„ªå…ˆï¼‰
  const SCALE_INHALE_MAX = 1.16;
  const SCALE_EXHALE_MIN = 0.80;

  let currentScale = 1.0;

  function setPhase(text, durationMs, scale, opacity, lockScale=false){
    instruction.textContent = text;

    if (lockScale) {
      circle.style.transitionDuration = "0ms";
      circle.style.transform = `scale(${currentScale})`;
      circle.style.opacity = String(opacity);
      return;
    }

    currentScale = scale;
    circle.style.transitionDuration = durationMs + "ms";
    circle.style.transform = `scale(${scale})`;
    circle.style.opacity = String(opacity);
  }

  function cueInhale(){ wood(300); }                 // ä½ï¼šå¸ã†
  function cueExhale(){ wood(220); }                 // ä½ï¼šåã
  function cueHold(){ wood(900); setTimeout(() => wood(900), 150); } // é«˜2å›ï¼šæ­¢ã‚ã‚‹

  // ===== å††ä¸­å¤®ã‚«ã‚¦ãƒ³ãƒˆ
  let countdownTimer = null;

  function startCountdown(seconds){
    clearInterval(countdownTimer);
    let remain = Number(seconds);
    if (!Number.isFinite(remain) || remain <= 0) {
      countdown.textContent = "";
      return;
    }
    countdown.textContent = String(remain);

    countdownTimer = setInterval(() => {
      remain--;
      if (remain <= 0) {
        clearInterval(countdownTimer);
        countdown.textContent = "";
      } else {
        countdown.textContent = String(remain);
      }
    }, 1000);
  }

  function clearCountdown(){
    clearInterval(countdownTimer);
    countdown.textContent = "";
  }

  function showHold(){
    clearInterval(countdownTimer);
    countdown.textContent = "HOLD";
  }

  // ===== ç‘æƒ³æ™‚é–“
  let startAtMs = null;
  function resetDurationView(){
    durationEl.style.display = "none";
    durationEl.textContent = "ä»Šå›ã®ç‘æƒ³æ™‚é–“ï¼š00:00";
  }
  function showDuration(){
    if (!startAtMs) return;
    const diffMs = Date.now() - startAtMs;
    const totalSec = Math.max(0, Math.floor(diffMs / 1000));
    const mm = String(Math.floor(totalSec / 60)).padStart(2, "0");
    const ss = String(totalSec % 60).padStart(2, "0");
    durationEl.textContent = `ä»Šå›ã®ç‘æƒ³æ™‚é–“ï¼š${mm}:${ss}`;
    durationEl.style.display = "block";
  }

    function cycle(){
      if (!running) return;
    
      const inhaleMs = parseInt(inhale.value, 10) * 1000;
      const exhaleMs = parseInt(exhale.value, 10) * 1000;
    
      // â‘  åãï¼ˆå…ˆã«åãï¼‰
      cueExhale();
      setPhase("åã„ã¦", exhaleMs, SCALE_EXHALE_MIN, 1.0, false);
      startCountdown(exhale.value);
      startMetronome();
    
      timer = setTimeout(() => {
        // â‘¡ æ­¢ã‚ã‚‹ï¼ˆãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ åœæ­¢ï¼‰
        cueHold();
        stopMetronome();
        setPhase("æ­¢ã‚ã‚‹", HOLD_MS, currentScale, 0.92, true);
        showHold();
    
        timer = setTimeout(() => {
          // â‘¢ å¸ã†ï¼ˆæ¬¡ã«å¸ã†ï¼šãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ å†é–‹ï¼‰
          cueInhale();
          setPhase("å¸ã£ã¦", inhaleMs, SCALE_INHALE_MAX, 1.0, false);
          startCountdown(inhale.value);
          startMetronome();
    
          timer = setTimeout(() => {
            // â‘£ æ­¢ã‚ã‚‹ï¼ˆãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ åœæ­¢ï¼‰
            cueHold();
            stopMetronome();
            setPhase("æ­¢ã‚ã‚‹", HOLD_MS, currentScale, 0.92, true);
            showHold();
    
            timer = setTimeout(() => {
              cycle(); // â‘¤ ç¹°ã‚Šè¿”ã—ï¼ˆåãã‹ã‚‰å§‹ã¾ã‚‹ï¼‰
            }, HOLD_MS);
    
          }, inhaleMs);
    
        }, HOLD_MS);
    
      }, exhaleMs);
    }

  function start(){
    if (running) return;
    running = true;
  
    // â˜… ãƒ†ãƒ¼ãƒåˆ¤å®š
    let appliedThemeId = themeSelect.value;
  
    if (appliedThemeId === "random") {
      const randomTheme = pickRandomTheme();
      appliedThemeId = randomTheme.id;
      applyTheme(appliedThemeId);
    } else {
      applyTheme(appliedThemeId);
    }
  
    // UIåŒæœŸï¼ˆãƒ©ãƒ³ãƒ€ãƒ æ™‚ã¯å®Ÿéš›ã®ãƒ†ãƒ¼ãƒåã«å¤‰ãˆã‚‹ï¼‰
    themeSelect.value = appliedThemeId;
  
    logUsageToSheet("start");
  
    setControlsEnabled(false);
    lockNote.style.display = "block";
  
    startAtMs = Date.now();
    resetDurationView();
  
    ensureAudio();
    bgm.play().catch(()=>{});
  
    currentScale = 1.0;
    circle.style.transitionDuration = "200ms";
    circle.style.transform = "scale(1)";
    circle.style.opacity = "0.92";
  
    cycle();
  }

  function stop(){
    if (!running) return;
    running = false;

    // ãƒ­ã‚°
    logUsageToSheet("stop");

    if (timer) clearTimeout(timer);
    timer = null;
    stopMetronome();
    clearCountdown();

    // ç‘æƒ³æ™‚é–“è¡¨ç¤º
    showDuration();
    startAtMs = null;

    instruction.textContent = "åœæ­¢ã—ã¾ã—ãŸ";
    circle.style.transitionDuration = "200ms";
    currentScale = 1.0;
    circle.style.transform = "scale(1)";
    circle.style.opacity = "0.92";
    bgm.pause();

    // ãƒ­ãƒƒã‚¯è§£é™¤
    setControlsEnabled(true);
    lockNote.style.display = "none";
  }

  document.getElementById("start").addEventListener("click", start);
  document.getElementById("stop").addEventListener("click", stop);

});
</script>
</body>
</html>




