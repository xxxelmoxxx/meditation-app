<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>呼吸瞑想アプリ</title>

<style>
  :root{
    --bg1:#667eea;
    --bg2:#764ba2;
    --card: rgba(255,255,255,.15);
    --text: #ffffff;
    --muted: rgba(255,255,255,.88);

    --accent:#38bdf8;      /* 円 */
    --start1:#22c55e;      /* 開始ボタン */
    --start2:#16a34a;
    --stop1:#6b7280;       /* 停止ボタン */
    --stop2:#4b5563;

    --shadow: rgba(0,0,0,.30);
  }

  body{
    font-family: system-ui, sans-serif;
    background: linear-gradient(135deg, var(--bg1), var(--bg2));
    color: var(--text);
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
    margin:0;
    padding: 16px;
    box-sizing:border-box;
  }

  .container{
    width: 390px;
    background: var(--card);
    padding: 18px 18px 20px;
    border-radius: 20px;
    box-shadow: 0 10px 30px var(--shadow);
    backdrop-filter: blur(10px);
  }

  h1{
    text-align:center;
    margin: 0 0 10px 0;
    font-size: 20px;
  }

  .row{
    display:flex;
    gap: 10px;
    align-items:center;
    justify-content:space-between;
    margin: 6px 0;
  }

  label{
    font-size: 13px;
    color: var(--muted);
    white-space: nowrap;
  }

  select{
    width: 56%;
    padding: 7px 10px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,.25);
    background: rgba(0,0,0,.15);
    color: var(--text);
    outline: none;
  }

  .divider{
    height: 1px;
    background: rgba(255,255,255,.18);
    margin: 10px 0;
  }

  /* 吸う/吐くを「行数詰め」 */
  .ranges{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 6px;
  }
  .rangeBox{
    display:flex;
    flex-direction:column;
    gap: 4px;
  }
  .lineLabel{
    display:flex;
    justify-content:space-between;
    align-items:baseline;
    gap: 10px;
    font-size: 13px;
    color: var(--muted);
    line-height: 1.1;
  }
  .lineLabel .val{
    color: var(--accent);
    font-weight: 800;
  }

  input[type=range]{
    width:100%;
    height: 6px;
    border-radius: 3px;
    background: rgba(255,255,255,.28);
    outline:none;
    -webkit-appearance:none;
  }
  input[type=range]::-webkit-slider-thumb{
    -webkit-appearance:none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
  }

  audio{
    width:100%;
    margin-top: 10px;
    border-radius: 10px;
  }

  .note{
    font-size: 12px;
    color: var(--muted);
    line-height: 1.35;
    text-align:center;
    margin-top: 6px;
  }

  /* ===== 重要：円エリアとテキストエリアを分離（被り防止） ===== */
  .visual{
    margin-top: 10px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap: 10px;
  }

  /* 円の表示領域を固定して、拡大しても文字へ侵入しにくくする */
  .circleWrap{
    width: 100%;
    height: 240px;      /* ←ここが効く：円が大きくなっても下に落ちにくい */
    display:flex;
    align-items:center;
    justify-content:center;
    overflow: hidden;   /* 念のため */
  }

  #circle{
    width: 170px;
    height: 170px;
    border-radius: 50%;
    background: var(--accent);
    box-shadow: 0 0 42px rgba(56,189,248,.45);
    transform: scale(1);
    opacity: .92;

    transition-property: transform, opacity;
    transition-timing-function: linear;
  }

  #instruction{
    text-align:center;
    font-size: 20px;
    min-height: 30px;
    font-weight: 700;
  }

  .controls{
    margin-top: 14px;
    display:flex;
    justify-content:space-between;
    gap: 12px;
  }

  button{
    width: 50%;
    padding: 12px;
    border: none;
    border-radius: 24px;
    font-size: 16px;
    cursor: pointer;
    color: white;
    transition: transform .15s ease;
  }
  button:hover{ transform: scale(1.03); }

  #start{
    background: linear-gradient(45deg, var(--start1), var(--start2));
  }
  #stop{
    background: linear-gradient(45deg, var(--stop1), var(--stop2));
  }
</style>
</head>

<body>
  <div class="container">
    <h1>呼吸瞑想アプリ</h1>

    <!-- テーマ -->
    <div class="row">
      <label for="themeSelect">テーマ</label>
      <select id="themeSelect">
        <option value="aurora" selected>オーロラ（青紫）</option>
        <option value="sunset">サンセット（橙ピンク）</option>
        <option value="forest">フォレスト（深緑）</option>
      </select>
    </div>

    <div class="divider"></div>

    <!-- メトロノーム -->
    <div class="row">
      <label for="metroOn">秒カウント（メトロノーム）</label>
      <input id="metroOn" type="checkbox" checked />
    </div>
    <div class="row">
      <label for="metroVol">メトロノーム音量</label>
      <input id="metroVol" type="range" min="0" max="100" value="35" />
    </div>

    <div class="divider"></div>

    <!-- 吸う/吐く（行数詰め） -->
    <div class="ranges">
      <div class="rangeBox">
        <div class="lineLabel">
          <span>吸う（秒）</span>
          <span class="val" id="inhaleVal">6秒</span>
        </div>
        <!-- 2〜10 中央=6 -->
        <input id="inhale" type="range" min="2" max="10" value="6" />
      </div>

      <div class="rangeBox">
        <div class="lineLabel">
          <span>吐く（秒）</span>
          <span class="val" id="exhaleVal">8秒</span>
        </div>
        <!-- 4〜12 中央=8 -->
        <input id="exhale" type="range" min="4" max="12" value="8" />
      </div>
    </div>

    <!-- BGM -->
    <audio id="bgm" src="music/bgm.mp3" preload="auto" controls></audio>

    <div class="note">
      合図音：低い音＝吸う/吐く　高い音2回＝息を止める（2秒）
    </div>
    <div class="note">
      BGM：優しい灯火 (Tenderly glow) / 蒲鉾さちこ（DOVA-SYNDROME）
    </div>

    <!-- ビジュアル -->
    <div class="visual">
      <div class="circleWrap">
        <div id="circle"></div>
      </div>
      <div id="instruction">準備ができたら開始を押してください</div>
        <div id="lockNote" class="note" style="display:none;">
        設定は停止後に変更できます
        </div>
    </div>

    <div class="controls">
      <button id="start">開始</button>
      <button id="stop">停止</button>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const inhale = document.getElementById("inhale");
  const exhale = document.getElementById("exhale");
  const inhaleVal = document.getElementById("inhaleVal");
  const exhaleVal = document.getElementById("exhaleVal");
  const circle = document.getElementById("circle");
  const instruction = document.getElementById("instruction");
  const lockNote = document.getElementById("lockNote");
  const bgm = document.getElementById("bgm");
  

  const themeSelect = document.getElementById("themeSelect");
  const metroOn = document.getElementById("metroOn");
  const metroVol = document.getElementById("metroVol");

  function setControlsEnabled(enabled){
  const controls = [themeSelect, metroOn, metroVol, inhale, exhale];

  controls.forEach(el => {
    el.disabled = !enabled;
  });

  // 見た目でも「ロック中」を分かりやすく（任意）
  const opacity = enabled ? "1" : "0.6";
  controls.forEach(el => {
    el.style.opacity = opacity;
    el.style.cursor = enabled ? "pointer" : "not-allowed";
  });
}

  let running = false;
  let timer = null;
  let metroTimer = null;

  // ===== 秒数表示
  function updateValues(){
    inhaleVal.textContent = inhale.value + "秒";
    exhaleVal.textContent = exhale.value + "秒";
  }
  inhale.addEventListener("input", updateValues);
  exhale.addEventListener("input", updateValues);
  updateValues();

  // ===== テーマ
  const themes = {
    aurora: {
      bg1:"#667eea", bg2:"#764ba2", card:"rgba(255,255,255,.15)",
      accent:"#38bdf8",
      start1:"#22c55e", start2:"#16a34a",
      stop1:"#6b7280", stop2:"#4b5563",
      shadow:"rgba(0,0,0,.30)"
    },
    sunset: {
      bg1:"#ff6a88", bg2:"#ff9a44", card:"rgba(0,0,0,.18)",
      accent:"#ffe08a",
      start1:"#0ea5e9", start2:"#2563eb",
      stop1:"#7c3aed", stop2:"#4c1d95",
      shadow:"rgba(0,0,0,.33)"
    },
    forest: {
      bg1:"#0f766e", bg2:"#064e3b", card:"rgba(255,255,255,.12)",
      accent:"#a7f3d0",
      start1:"#f59e0b", start2:"#d97706",
      stop1:"#374151", stop2:"#111827",
      shadow:"rgba(0,0,0,.35)"
    }
  };

  function applyTheme(key){
    const t = themes[key] || themes.aurora;
    const r = document.documentElement.style;
    r.setProperty("--bg1", t.bg1);
    r.setProperty("--bg2", t.bg2);
    r.setProperty("--card", t.card);
    r.setProperty("--accent", t.accent);
    r.setProperty("--start1", t.start1);
    r.setProperty("--start2", t.start2);
    r.setProperty("--stop1", t.stop1);
    r.setProperty("--stop2", t.stop2);
    r.setProperty("--shadow", t.shadow);
  }
  themeSelect.addEventListener("change", () => applyTheme(themeSelect.value));
  applyTheme(themeSelect.value);

  // ===== 音
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  function ensureAudio(){
    if (audioCtx.state === "suspended") {
      audioCtx.resume().catch(()=>{});
    }
  }

  // 合図音（木：コツ）…意味のある音
  function wood(freq = 300, duration = 0.11, gainPeak = 0.35){
    ensureAudio();
    const now = audioCtx.currentTime;

    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    const filter = audioCtx.createBiquadFilter();

    osc.type = "square";
    osc.frequency.value = freq;

    filter.type = "bandpass";
    filter.frequency.value = Math.min(2400, freq * 3);

    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(gainPeak, now + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, now + duration);

    osc.connect(filter);
    filter.connect(g);
    g.connect(audioCtx.destination);

    osc.start(now);
    osc.stop(now + duration);
  }

  // メトロノーム（ノイズクリック：チッ）…背景の時間
  function metroClick(accent = false){
    const vol = Math.max(0, Math.min(1, parseInt(metroVol.value, 10) / 100));
    if (vol === 0) return;

    ensureAudio();
    const now = audioCtx.currentTime;

    // 30msのホワイトノイズ
    const bufferSize = Math.floor(audioCtx.sampleRate * 0.03);
    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) {
      data[i] = Math.random() * 2 - 1;
    }

    const noise = audioCtx.createBufferSource();
    noise.buffer = buffer;

    const gain = audioCtx.createGain();
    const filter = audioCtx.createBiquadFilter();

    // 高域だけ通して「チッ」感を出す
    filter.type = "highpass";
    filter.frequency.value = 2500;

    const peak = accent
      ? (0.05 + vol * 0.18)
      : (0.03 + vol * 0.12);

    gain.gain.setValueAtTime(0.0001, now);
    gain.gain.exponentialRampToValueAtTime(peak, now + 0.005);
    gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.03);

    noise.connect(filter);
    filter.connect(gain);
    gain.connect(audioCtx.destination);

    noise.start(now);
    noise.stop(now + 0.04);
  }

  function startMetronome(){
    stopMetronome();
    if (!metroOn.checked) return;

    // フェーズ開始はアクセント
    metroClick(true);
    metroTimer = setInterval(() => metroClick(false), 1000);
  }

  function stopMetronome(){
    if (metroTimer) {
      clearInterval(metroTimer);
      metroTimer = null;
    }
  }

  // ===== 呼吸フェーズ
  const HOLD_MS = 2000;

  // 円が被らないための最大/最小（必要なら少し下げる）
  const SCALE_INHALE_MAX = 1.18; // ここを下げるほど被りにくい（例：1.15）
  const SCALE_EXHALE_MIN = 0.80;

  // 「止める」はサイズを変えないため、直前スケールを保持
  let currentScale = 1.0;

  function setPhase(text, durationMs, scale, opacity, lockScale=false){
    instruction.textContent = text;

    if (lockScale) {
      // 止める：サイズ変えない & 変化を止める
      circle.style.transitionDuration = "0ms";
      circle.style.transform = `scale(${currentScale})`;
      circle.style.opacity = String(opacity);
      return;
    }

    currentScale = scale;
    circle.style.transitionDuration = durationMs + "ms";
    circle.style.transform = `scale(${scale})`;
    circle.style.opacity = String(opacity);
  }

  function cueInhale(){ wood(300); }                 // 低：吸う
  function cueExhale(){ wood(220); }                 // 低：吐く（さらに低）
  function cueHold(){ wood(900); setTimeout(() => wood(900), 150); } // 高2回：止める

  function cycle(){
  if (!running) return;

  const inhaleMs = parseInt(inhale.value, 10) * 1000;
  const exhaleMs = parseInt(exhale.value, 10) * 1000;

  // 吸う
  cueInhale();
  setPhase("吸って", inhaleMs, SCALE_INHALE_MAX, 1.0, false);
  startMetronome();

  timer = setTimeout(() => {
    // 止める（サイズ固定・メトロノーム停止）
    cueHold();
    stopMetronome();
    setPhase("止める", HOLD_MS, currentScale, 0.92, true);

    timer = setTimeout(() => {
      // 吐く（メトロノーム再開）
      cueExhale();
      setPhase("吐いて", exhaleMs, SCALE_EXHALE_MIN, 1.0, false);
      startMetronome();

      timer = setTimeout(() => {
        // 止める（サイズ固定・メトロノーム停止）
        cueHold();
        stopMetronome();
        setPhase("止める", HOLD_MS, currentScale, 0.92, true);

        timer = setTimeout(() => {
          cycle();
        }, HOLD_MS);

      }, exhaleMs);

    }, HOLD_MS);

  }, inhaleMs);
}

  function start(){
    if (running) return;
    running = true;
    
    setControlsEnabled(false);      // ★ロック
    lockNote.style.display = "block"; // ★表示

    ensureAudio();
    bgm.play().catch(()=>{ /* controlsで手動再生可 */ });

    // 初期状態
    currentScale = 1.0;
    circle.style.transitionDuration = "200ms";
    circle.style.transform = "scale(1)";
    circle.style.opacity = "0.92";

    cycle();
  }

  function stop(){
    running = false;
    if (timer) clearTimeout(timer);
    timer = null;
    stopMetronome();

    instruction.textContent = "停止しました";
    circle.style.transitionDuration = "200ms";
    currentScale = 1.0;
    circle.style.transform = "scale(1)";
    circle.style.opacity = "0.92";
    bgm.pause();

    setControlsEnabled(true);
    lockNote.style.display = "none"; // ★非表示
  }

  document.getElementById("start").addEventListener("click", start);
  document.getElementById("stop").addEventListener("click", stop);
});
</script>
</body>
</html>



