<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>呼吸瞑想アプリ</title>
<link rel="icon" href="favicon.png" type="image/png">
<link rel="apple-touch-icon" href="favicon.png">
<style>
  :root{
    --bg1:#667eea;
    --bg2:#764ba2;
    --card: rgba(255,255,255,.15);
    --text: #ffffff;
    --muted: rgba(255,255,255,.88);

    --accent:#38bdf8;      /* 円 */
    --start1:#22c55e;      /* 開始ボタン */
    --start2:#16a34a;
    --stop1:#6b7280;       /* 停止ボタン */
    --stop2:#4b5563;

    --shadow: rgba(0,0,0,.30);

    --accent2:#A78BFA;
  }

  body{
    font-family: system-ui, sans-serif;
    background: linear-gradient(135deg, var(--bg1), var(--bg2));
    color: var(--text);
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
    margin:0;
    padding: 16px;
    box-sizing:border-box;
  }

  .container{
    width: 390px;
    background: var(--card);
    padding: 18px 18px 20px;
    border-radius: 20px;
    box-shadow: 0 10px 30px var(--shadow);
    backdrop-filter: blur(10px);
  }

  h1{
    text-align:center;
    margin: 0 0 10px 0;
    font-size: 20px;
  }

  .row{
    display:flex;
    gap: 10px;
    align-items:center;
    justify-content:space-between;
    margin: 6px 0;
  }

  label{
    font-size: 13px;
    color: var(--muted);
    white-space: nowrap;
  }

  select{
    width: 56%;
    padding: 7px 10px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,.25);
    background: rgba(0,0,0,.15);
    color: var(--text);
    outline: none;
  }

  .divider{
    height: 1px;
    background: rgba(255,255,255,.18);
    margin: 10px 0;
  }

  /* 吸う/吐くを「行数詰め」 */
  .ranges{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 6px;
  }
  .rangeBox{
    display:flex;
    flex-direction:column;
    gap: 4px;
  }
  .lineLabel{
    display:flex;
    justify-content:space-between;
    align-items:baseline;
    gap: 10px;
    font-size: 13px;
    color: var(--muted);
    line-height: 1.1;
  }
  .lineLabel .val{
    color: var(--accent);
    font-weight: 800;
  }

  input[type=range]{
    width:100%;
    height: 6px;
    border-radius: 3px;
    background: rgba(255,255,255,.28);
    outline:none;
    -webkit-appearance:none;
  }
  input[type=range]::-webkit-slider-thumb{
    -webkit-appearance:none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
  }

  audio{
    width:100%;
    margin-top: 10px;
    border-radius: 10px;
  }

  .note{
    font-size: 12px;
    color: var(--muted);
    line-height: 1.35;
    text-align:center;
    margin-top: 6px;
  }

  /* ===== 重要：円エリアとテキストエリアを分離（被り防止） ===== */
  .visual{
    margin-top: 10px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap: 10px;
  }

  /* 円の表示領域を固定して、拡大しても文字へ侵入しにくくする */
  .circleWrap{
    width: 100%;
    height: 240px;      /* ←ここが効く：円が大きくなっても下に落ちにくい */
    display:flex;
    align-items:center;
    justify-content:center;
    overflow: hidden;   /* 念のため */
  }

  #circle{
  position: relative; /* ★追加 */
  width: 170px;
  height: 170px;
  border-radius: 50%;
  background: var(--accent);
  box-shadow: 0 0 42px rgba(56,189,248,.45);
  transform: scale(1);
  opacity: .92;
  transition-property: transform, opacity;
  transition-timing-function: linear;
}

#countdown{
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 48px;
  font-weight: 800;
  color: #ffffff;
  opacity: 0.9;
  pointer-events: none; /* 操作邪魔しない */
  user-select: none;
}

  #instruction{
    text-align:center;
    font-size: 20px;
    min-height: 30px;
    font-weight: 700;
  }

  .controls{
    margin-top: 14px;
    display:flex;
    justify-content:space-between;
    gap: 12px;
  }

  button{
    width: 50%;
    padding: 12px;
    border: none;
    border-radius: 24px;
    font-size: 16px;
    cursor: pointer;
    color: white;
    transition: transform .15s ease;
  }
  button:hover{ transform: scale(1.03); }

  #start{
    background: linear-gradient(45deg, var(--start1), var(--start2));
  }
  #stop{
    background: linear-gradient(45deg, var(--stop1), var(--stop2));
  }
</style>
</head>

<body>
  <div class="container">
    <h1>呼吸瞑想アプリ</h1>

    <!-- テーマ -->
    <div class="row">
      <label for="themeSelect">テーマ</label>
      <select id="themeSelect"></select>
    </div>

    <div class="divider"></div>

    <!-- メトロノーム -->
    <div class="row">
      <label for="metroOn">秒カウント（メトロノーム）</label>
      <input id="metroOn" type="checkbox" checked />
    </div>
    
    <div class="divider"></div>

    <!-- 吸う/吐く（行数詰め） -->
    <div class="ranges">
      <div class="rangeBox">
        <div class="lineLabel">
          <span>吸う（秒）</span>
          <span class="val" id="inhaleVal">6秒</span>
        </div>
        <!-- 2〜10 中央=6 -->
        <input id="inhale" type="range" min="2" max="10" value="6" />
      </div>

      <div class="rangeBox">
        <div class="lineLabel">
          <span>吐く（秒）</span>
          <span class="val" id="exhaleVal">8秒</span>
        </div>
        <!-- 4〜12 中央=8 -->
        <input id="exhale" type="range" min="4" max="12" value="8" />
      </div>
    </div>

    <!-- BGM -->
    <audio id="bgm" src="music/bgm.mp3" preload="auto" controls loop></audio>

    <div class="note">
      合図音：低い音＝吸う/吐く　高い音2回＝息を止める（2秒）
    </div>
    <div class="note">
      BGM：優しい灯火 (Tenderly glow) / 蒲鉾さちこ（DOVA-SYNDROME）
    </div>

    <!-- ビジュアル -->
    <div class="visual">
      <div class="circleWrap">
        <div id="circle">
          <div id="countdown"> </div>
        </div>
      </div>
      <div id="instruction">準備ができたら開始を押してください</div>
      <div id="duration" class="note" style="display:none; font-weight:700;">
        今回の瞑想時間：00:00
      </div>
        <div id="lockNote" class="note" style="display:none;">
        設定は停止後に変更できます
        </div>
    </div>

    <div class="controls">
      <button id="start">開始</button>
      <button id="stop">停止</button>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const inhale = document.getElementById("inhale");
  const exhale = document.getElementById("exhale");
  const inhaleVal = document.getElementById("inhaleVal");
  const exhaleVal = document.getElementById("exhaleVal");
  const circle = document.getElementById("circle");
  const countdown = document.getElementById("countdown");
  const instruction = document.getElementById("instruction");
  const durationEl = document.getElementById("duration");
  const lockNote = document.getElementById("lockNote");
  const bgm = document.getElementById("bgm");
  bgm.volume = 0.6;

  const themeSelect = document.getElementById("themeSelect");
  const metroOn = document.getElementById("metroOn");

// ===== 利用ログ（Google Sheets / Apps Script）
const LOG_ENDPOINT = "https://script.google.com/macros/s/AKfycbw-jwQvwnJRL3D34bCXAtt64fxEW-vS58rRPz_hgntAzfQEAFFIVnF5L_5S5d_Wq_sYKA/exec";

function getClientId() {
  const key = "breathing_client_id";
  let id = localStorage.getItem(key);
  if (!id) {
    id = (window.crypto && crypto.randomUUID)
      ? crypto.randomUUID()
      : ("id_" + Math.random().toString(36).slice(2) + Date.now().toString(36));
    localStorage.setItem(key, id);
  }
  return id;
}

function logUsageToSheet(action) {
  const url = new URL(LOG_ENDPOINT);

  // 共通（start/stop 両方）
  url.searchParams.set("action", action);
  url.searchParams.set("inhale", inhale.value);
  url.searchParams.set("exhale", exhale.value);
  url.searchParams.set("clientId", getClientId());
  url.searchParams.set("userAgent", navigator.userAgent);
  url.searchParams.set("referrer", document.referrer || "");
  url.searchParams.set("t", String(Date.now())); // キャッシュ避け

  // start時だけ設定も送る
  if (action === "start") {
    url.searchParams.set("theme", themeSelect.value);
    url.searchParams.set("metroOn", metroOn.checked ? "1" : "0");
  } else {
    // stop では空（列合わせ）
    url.searchParams.set("theme", "");
    url.searchParams.set("metroOn", "");
  }

  // CORS回避：画像リクエストで送る（レスポンスは読まない）
  const img = new Image();
  img.src = url.toString();
}
  
  function setControlsEnabled(enabled){
  const controls = [themeSelect, metroOn, inhale, exhale];

  controls.forEach(el => {
    el.disabled = !enabled;
  });

  // 見た目でも「ロック中」を分かりやすく（任意）
  const opacity = enabled ? "1" : "0.6";
  controls.forEach(el => {
    el.style.opacity = opacity;
    el.style.cursor = enabled ? "pointer" : "not-allowed";
  });
}

  let running = false;
  let startAtMs = null;
  let timer = null;
  let metroTimer = null;

  // ===== 秒数表示
  function updateValues(){
    inhaleVal.textContent = inhale.value + "秒";
    exhaleVal.textContent = exhale.value + "秒";
  }
  inhale.addEventListener("input", updateValues);
  exhale.addEventListener("input", updateValues);
  updateValues();

// ===== テーマ（1回選択：10カテゴリ×テーマ）
const CATEGORY_LABELS = [
  "Calm / 癒し（やわらかい・落ち着く）",
  "Fresh / 爽やか（軽い・清潔感）",
  "Trust / 信頼（ビジネス・堅実）",
  "Warm / あたたかい（親しみ・安心）",
  "Pop / 元気（明るい・強い）",
  "Retro / レトロ（ノスタルジー・世界観）",
  "Nature / 自然（オーガニック・緑）",
  "Night / 夜（ダーク・集中）",
  "Mono / モノトーン（最小構成・汎用）",
  "Pastel / パステル（可愛い・柔和）",
];

// テーマ定義（あなたの例をそのまま）
const THEMES = [
  // 1) Calm / 癒し
  {
    id: "calm_mist",
    label: "癒し：ミスト",
    category: "Calm / 癒し（やわらかい・落ち着く）",
    vars: {
      "--bg1": "#BFE7F6",
      "--bg2": "#D9C7FF",
      "--card": "rgba(255,255,255,.18)",
      "--text": "#0B1020",
      "--muted": "rgba(11,16,32,.75)",
      "--accent": "#2DD4BF",
      "--accent2": "#A78BFA",
    }
  },
  {
    id: "calm_sand",
    label: "癒し：サンド",
    category: "Calm / 癒し（やわらかい・落ち着く）",
    vars: {
      "--bg1": "#F7E7CE",
      "--bg2": "#F3D6D6",
      "--card": "rgba(255,255,255,.20)",
      "--text": "#1F2937",
      "--muted": "rgba(31,41,55,.72)",
      "--accent": "#F59E0B",
      "--accent2": "#FB7185",
    }
  },

  // 2) Fresh / 爽やか
  {
    id: "fresh_aqua",
    label: "爽やか：アクア",
    category: "Fresh / 爽やか（軽い・清潔感）",
    vars: {
      "--bg1": "#7DD3FC",
      "--bg2": "#A7F3D0",
      "--card": "rgba(255,255,255,.16)",
      "--text": "#06203A",
      "--muted": "rgba(6,32,58,.72)",
      "--accent": "#0EA5E9",
      "--accent2": "#10B981",
    }
  },
  {
    id: "fresh_ice",
    label: "爽やか：アイス",
    category: "Fresh / 爽やか（軽い・清潔感）",
    vars: {
      "--bg1": "#E0F2FE",
      "--bg2": "#E5E7EB",
      "--card": "rgba(255,255,255,.22)",
      "--text": "#0F172A",
      "--muted": "rgba(15,23,42,.70)",
      "--accent": "#38BDF8",
      "--accent2": "#94A3B8",
    }
  },

  // 3) Trust / 信頼
  {
    id: "trust_navy",
    label: "信頼：ネイビー",
    category: "Trust / 信頼（ビジネス・堅実）",
    vars: {
      "--bg1": "#0F172A",
      "--bg2": "#1F2937",
      "--card": "rgba(255,255,255,.08)",
      "--text": "#F8FAFC",
      "--muted": "rgba(248,250,252,.78)",
      "--accent": "#60A5FA",
      "--accent2": "#94A3B8",
    }
  },
  {
    id: "trust_brick",
    label: "信頼：ブリック",
    category: "Trust / 信頼（ビジネス・堅実）",
    vars: {
      "--bg1": "#111827",
      "--bg2": "#374151",
      "--card": "rgba(255,255,255,.09)",
      "--text": "#F9FAFB",
      "--muted": "rgba(249,250,251,.76)",
      "--accent": "#B45309",
      "--accent2": "#93C5FD",
    }
  },

  // 4) Warm / あたたかい
  {
    id: "warm_sunset",
    label: "あたたかい：サンセット",
    category: "Warm / あたたかい（親しみ・安心）",
    vars: {
      "--bg1": "#FB923C",
      "--bg2": "#F472B6",
      "--card": "rgba(255,255,255,.14)",
      "--text": "#2A0A0A",
      "--muted": "rgba(42,10,10,.72)",
      "--accent": "#F97316",
      "--accent2": "#EC4899",
    }
  },
  {
    id: "warm_cocoa",
    label: "あたたかい：ココア",
    category: "Warm / あたたかい（親しみ・安心）",
    vars: {
      "--bg1": "#A16207",
      "--bg2": "#7C2D12",
      "--card": "rgba(255,255,255,.10)",
      "--text": "#FFF7ED",
      "--muted": "rgba(255,247,237,.78)",
      "--accent": "#FBBF24",
      "--accent2": "#FDBA74",
    }
  },

  // 5) Pop / 元気
  {
    id: "pop_candy",
    label: "元気：キャンディ",
    category: "Pop / 元気（明るい・強い）",
    vars: {
      "--bg1": "#22C55E",
      "--bg2": "#06B6D4",
      "--card": "rgba(255,255,255,.13)",
      "--text": "#04130C",
      "--muted": "rgba(4,19,12,.70)",
      "--accent": "#FDE047",
      "--accent2": "#FB7185",
    }
  },
  {
    id: "pop_tropical",
    label: "元気：トロピカル",
    category: "Pop / 元気（明るい・強い）",
    vars: {
      "--bg1": "#38BDF8",
      "--bg2": "#F97316",
      "--card": "rgba(255,255,255,.12)",
      "--text": "#0B1220",
      "--muted": "rgba(11,18,32,.72)",
      "--accent": "#A3E635",
      "--accent2": "#F43F5E",
    }
  },

  // 6) Retro / レトロ
  {
    id: "retro_aqua_gold",
    label: "レトロ：アクア×ゴールド",
    category: "Retro / レトロ（ノスタルジー・世界観）",
    vars: {
      "--bg1": "#67E8F9",
      "--bg2": "#FDE68A",
      "--card": "rgba(255,255,255,.18)",
      "--text": "#1F2937",
      "--muted": "rgba(31,41,55,.72)",
      "--accent": "#CA8A04",
      "--accent2": "#0EA5E9",
    }
  },
  {
    id: "retro_olive",
    label: "レトロ：オリーブ",
    category: "Retro / レトロ（ノスタルジー・世界観）",
    vars: {
      "--bg1": "#A3A635",
      "--bg2": "#0F766E",
      "--card": "rgba(255,255,255,.10)",
      "--text": "#F8FAFC",
      "--muted": "rgba(248,250,252,.78)",
      "--accent": "#F59E0B",
      "--accent2": "#EAB308",
    }
  },

  // 7) Nature / 自然
  {
    id: "nature_forest",
    label: "自然：フォレスト",
    category: "Nature / 自然（オーガニック・緑）",
    vars: {
      "--bg1": "#14532D",
      "--bg2": "#0F766E",
      "--card": "rgba(255,255,255,.09)",
      "--text": "#ECFDF5",
      "--muted": "rgba(236,253,245,.78)",
      "--accent": "#84CC16",
      "--accent2": "#FDE047",
    }
  },
  {
    id: "nature_meadow",
    label: "自然：メドウ",
    category: "Nature / 自然（オーガニック・緑）",
    vars: {
      "--bg1": "#A7F3D0",
      "--bg2": "#BBF7D0",
      "--card": "rgba(255,255,255,.20)",
      "--text": "#052016",
      "--muted": "rgba(5,32,22,.70)",
      "--accent": "#22C55E",
      "--accent2": "#10B981",
    }
  },

  // 8) Night / 夜
  {
    id: "night_indigo",
    label: "夜：インディゴ",
    category: "Night / 夜（ダーク・集中）",
    vars: {
      "--bg1": "#111827",
      "--bg2": "#312E81",
      "--card": "rgba(255,255,255,.08)",
      "--text": "#F8FAFC",
      "--muted": "rgba(248,250,252,.76)",
      "--accent": "#A78BFA",
      "--accent2": "#38BDF8",
    }
  },
  {
    id: "night_aurora",
    label: "夜：オーロラ",
    category: "Night / 夜（ダーク・集中）",
    vars: {
      "--bg1": "#020617",
      "--bg2": "#064E3B",
      "--card": "rgba(255,255,255,.07)",
      "--text": "#E2E8F0",
      "--muted": "rgba(226,232,240,.75)",
      "--accent": "#2DD4BF",
      "--accent2": "#84CC16",
    }
  },

  // 9) Mono / モノトーン
  {
    id: "mono_light",
    label: "モノ：ライト",
    category: "Mono / モノトーン（最小構成・汎用）",
    vars: {
      "--bg1": "#F8FAFC",
      "--bg2": "#E5E7EB",
      "--card": "rgba(0,0,0,.06)",
      "--text": "#0F172A",
      "--muted": "rgba(15,23,42,.70)",
      "--accent": "#111827",
      "--accent2": "#64748B",
    }
  },
  {
    id: "mono_dark",
    label: "モノ：ダーク",
    category: "Mono / モノトーン（最小構成・汎用）",
    vars: {
      "--bg1": "#0B1020",
      "--bg2": "#111827",
      "--card": "rgba(255,255,255,.08)",
      "--text": "#F1F5F9",
      "--muted": "rgba(241,245,249,.76)",
      "--accent": "#E5E7EB",
      "--accent2": "#94A3B8",
    }
  },

  // 10) Pastel / パステル
  {
    id: "pastel_sakura",
    label: "パステル：さくら",
    category: "Pastel / パステル（可愛い・柔和）",
    vars: {
      "--bg1": "#FBCFE8",
      "--bg2": "#E9D5FF",
      "--card": "rgba(255,255,255,.22)",
      "--text": "#1F2937",
      "--muted": "rgba(31,41,55,.70)",
      "--accent": "#FB7185",
      "--accent2": "#A78BFA",
    }
  },
  {
    id: "pastel_lemon",
    label: "パステル：レモン",
    category: "Pastel / パステル（可愛い・柔和）",
    vars: {
      "--bg1": "#FEF9C3",
      "--bg2": "#CFFAFE",
      "--card": "rgba(255,255,255,.22)",
      "--text": "#1F2937",
      "--muted": "rgba(31,41,55,.70)",
      "--accent": "#EAB308",
      "--accent2": "#06B6D4",
    }
  },
];

function applyThemeById(themeId){
  const theme = THEMES.find(t => t.id === themeId);
  if (!theme) return;

  const root = document.documentElement;
  Object.entries(theme.vars).forEach(([k, v]) => root.style.setProperty(k, v));

  // accent2 はCSS側で未使用でもOK（将来用）
}

// select を「1回で選べる」形で生成（カテゴリは短縮せず、そのまま表示）
function buildThemeSelect(){
  themeSelect.innerHTML = "";

  // カテゴリ順を固定（あなたが指定した10カテゴリの順）
  CATEGORY_LABELS.forEach(catLabel => {
    const group = document.createElement("optgroup");
    group.label = catLabel;

    THEMES.filter(t => t.category === catLabel).forEach(t => {
      const opt = document.createElement("option");
      opt.value = t.id;
      opt.textContent = `${t.category} / ${t.label}`; // 1回で分かるように表示
      group.appendChild(opt);
    });

    themeSelect.appendChild(group);
  });

  // デフォルト（今までの aurora 相当の雰囲気に近いもの）
  themeSelect.value = "calm_mist";
  applyThemeById(themeSelect.value);
}

themeSelect.addEventListener("change", () => applyThemeById(themeSelect.value));
buildThemeSelect();

  function applyTheme(key){
    const t = themes[key] || themes.aurora;
    const r = document.documentElement.style;
    r.setProperty("--bg1", t.bg1);
    r.setProperty("--bg2", t.bg2);
    r.setProperty("--card", t.card);
    r.setProperty("--accent", t.accent);
    r.setProperty("--start1", t.start1);
    r.setProperty("--start2", t.start2);
    r.setProperty("--stop1", t.stop1);
    r.setProperty("--stop2", t.stop2);
    r.setProperty("--shadow", t.shadow);
  }
  themeSelect.addEventListener("change", () => applyTheme(themeSelect.value));
  applyTheme(themeSelect.value);

  // ===== 音
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  function ensureAudio(){
    if (audioCtx.state === "suspended") {
      audioCtx.resume().catch(()=>{});
    }
  }

  // 合図音（木：コツ）…意味のある音
  function wood(freq = 300, duration = 0.11, gainPeak = 0.35){
    ensureAudio();
    const now = audioCtx.currentTime;

    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    const filter = audioCtx.createBiquadFilter();

    osc.type = "square";
    osc.frequency.value = freq;

    filter.type = "bandpass";
    filter.frequency.value = Math.min(2400, freq * 3);

    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(gainPeak, now + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, now + duration);

    osc.connect(filter);
    filter.connect(g);
    g.connect(audioCtx.destination);

    osc.start(now);
    osc.stop(now + duration);
  }

  // メトロノーム（ノイズクリック：チッ）…背景の時間
  function metroClick(accent = false){
    const vol = accent ? 0.18 : 0.12;

    ensureAudio();
    const now = audioCtx.currentTime;

    // 30msのホワイトノイズ
    const bufferSize = Math.floor(audioCtx.sampleRate * 0.03);
    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) {
      data[i] = Math.random() * 2 - 1;
    }

    const noise = audioCtx.createBufferSource();
    noise.buffer = buffer;

    const gain = audioCtx.createGain();
    const filter = audioCtx.createBiquadFilter();

    // 高域だけ通して「チッ」感を出す
    filter.type = "highpass";
    filter.frequency.value = 2500;

    const peak = accent
      ? (0.05 + vol * 0.18)
      : (0.03 + vol * 0.12);

    gain.gain.setValueAtTime(0.0001, now);
    gain.gain.exponentialRampToValueAtTime(peak, now + 0.005);
    gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.03);

    noise.connect(filter);
    filter.connect(gain);
    gain.connect(audioCtx.destination);

    noise.start(now);
    noise.stop(now + 0.04);
  }

  function startMetronome(){
    stopMetronome();
    if (!metroOn.checked) return;

    // フェーズ開始はアクセント
    metroClick(true);
    metroTimer = setInterval(() => metroClick(false), 1000);
  }

  function stopMetronome(){
    if (metroTimer) {
      clearInterval(metroTimer);
      metroTimer = null;
    }
  }

  // ===== 呼吸フェーズ
  const HOLD_MS = 2000;

  // 円が被らないための最大/最小（必要なら少し下げる）
  const SCALE_INHALE_MAX = 1.18; // ここを下げるほど被りにくい（例：1.15）
  const SCALE_EXHALE_MIN = 0.80;

  // 「止める」はサイズを変えないため、直前スケールを保持
  let currentScale = 1.0;

  function setPhase(text, durationMs, scale, opacity, lockScale=false){
    instruction.textContent = text;

    if (lockScale) {
      // 止める：サイズ変えない & 変化を止める
      circle.style.transitionDuration = "0ms";
      circle.style.transform = `scale(${currentScale})`;
      circle.style.opacity = String(opacity);
      return;
    }

    currentScale = scale;
    circle.style.transitionDuration = durationMs + "ms";
    circle.style.transform = `scale(${scale})`;
    circle.style.opacity = String(opacity);
  }

  function cueInhale(){ wood(300); }                 // 低：吸う
  function cueExhale(){ wood(220); }                 // 低：吐く（さらに低）
  function cueHold(){ wood(900); setTimeout(() => wood(900), 150); } // 高2回：止める

  function cycle(){
  if (!running) return;

  const inhaleMs = parseInt(inhale.value, 10) * 1000;
  const exhaleMs = parseInt(exhale.value, 10) * 1000;

  // 吸う
  cueInhale();
  setPhase("吸って", inhaleMs, SCALE_INHALE_MAX, 1.0, false);
  startCountdown(inhale.value); // ★追加
  startMetronome();

  timer = setTimeout(() => {
    // 止める（サイズ固定・メトロノーム停止）
    cueHold();
    stopMetronome();
    setPhase("止める", HOLD_MS, currentScale, 0.92, true);
    showHold();

    timer = setTimeout(() => {
      // 吐く（メトロノーム再開）
      cueExhale();
      setPhase("吐いて", exhaleMs, SCALE_EXHALE_MIN, 1.0, false);
      startCountdown(exhale.value); // ★追加
      startMetronome();

      timer = setTimeout(() => {
        // 止める（サイズ固定・メトロノーム停止）
        cueHold();
        stopMetronome();
        setPhase("止める", HOLD_MS, currentScale, 0.92, true);
        showHold();

        timer = setTimeout(() => {
          cycle();
        }, HOLD_MS);

      }, exhaleMs);

    }, HOLD_MS);

  }, inhaleMs);
}

  function start(){
    if (running) return;
    running = true;
    startAtMs = Date.now();
    durationEl.style.display = "none";
    durationEl.textContent = "今回の瞑想時間：00:00";

    logUsageToSheet("start"); // ★開始ログ

    setControlsEnabled(false);      // ★ロック
    lockNote.style.display = "block"; // ★表示

    ensureAudio();
    bgm.play().catch(()=>{ /* controlsで手動再生可 */ });

    // 初期状態
    currentScale = 1.0;
    circle.style.transitionDuration = "200ms";
    circle.style.transform = "scale(1)";
    circle.style.opacity = "0.92";

    cycle();
  }

  function stop(){
    if (!running) return;      // ★二重停止ログ防止
    running = false;
    if (startAtMs) {
      const diffMs = Date.now() - startAtMs;
      const totalSec = Math.max(0, Math.floor(diffMs / 1000));
      const mm = String(Math.floor(totalSec / 60)).padStart(2, "0");
      const ss = String(totalSec % 60).padStart(2, "0");

      durationEl.textContent = `今回の瞑想時間：${mm}:${ss}`;
      durationEl.style.display = "block";
    }
    startAtMs = null;

    logUsageToSheet("stop");   // ★停止ログ

    if (timer) clearTimeout(timer);
    timer = null;
    stopMetronome();
    clearCountdown();

    instruction.textContent = "停止しました";
    circle.style.transitionDuration = "200ms";
    currentScale = 1.0;
    circle.style.transform = "scale(1)";
    circle.style.opacity = "0.92";
    bgm.pause();

    setControlsEnabled(true);
    lockNote.style.display = "none"; // ★非表示
  }

let countdownTimer = null;

function startCountdown(seconds){
  clearInterval(countdownTimer);
  let remain = seconds;
  countdown.textContent = remain;

  countdownTimer = setInterval(() => {
    remain--;
    if (remain <= 0) {
      clearInterval(countdownTimer);
      countdown.textContent = "";
    } else {
      countdown.textContent = remain;
    }
  }, 1000);
}

function clearCountdown(){
  clearInterval(countdownTimer);
  countdown.textContent = "";
}

function showHold(){
  clearInterval(countdownTimer);
  countdown.textContent = "HOLD";
}

  document.getElementById("start").addEventListener("click", start);
  document.getElementById("stop").addEventListener("click", stop);
});
</script>
</body>
</html>


















