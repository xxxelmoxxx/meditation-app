<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>呼吸瞑想アプリ</title>

<style>
  :root{
    --bg1:#667eea;
    --bg2:#764ba2;
    --card: rgba(255,255,255,.15);
    --text: #ffffff;
    --muted: rgba(255,255,255,.85);

    --accent:#38bdf8;      /* 円 */
    --start1:#22c55e;      /* 開始ボタン */
    --start2:#16a34a;
    --stop1:#6b7280;       /* 停止ボタン */
    --stop2:#4b5563;

    --shadow: rgba(0,0,0,.30);
  }

  body{
    font-family: system-ui, sans-serif;
    background: linear-gradient(135deg, var(--bg1), var(--bg2));
    color: var(--text);
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
    margin:0;
    padding: 20px;
    box-sizing:border-box;
  }

  .container{
    width: 380px;
    background: var(--card);
    padding: 24px;
    border-radius: 20px;
    box-shadow: 0 10px 30px var(--shadow);
    backdrop-filter: blur(10px);
  }

  h1{
    text-align:center;
    margin: 0 0 18px 0;
    font-size: 22px;
  }

  .row{
    display:flex;
    gap: 10px;
    align-items:center;
    justify-content:space-between;
    margin-bottom: 10px;
  }

  .row label{
    font-size: 13px;
    color: var(--muted);
  }

  select, input[type="checkbox"]{
    cursor: pointer;
  }

  select{
    width: 55%;
    padding: 8px 10px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,.25);
    background: rgba(0,0,0,.15);
    color: var(--text);
    outline: none;
  }

  .settings{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 10px;
  }

  label{
    font-size: 14px;
    margin-bottom: 4px;
    display:block;
  }

  input[type=range]{
    width:100%;
    height: 6px;
    border-radius: 3px;
    background: rgba(255,255,255,.28);
    outline:none;
    -webkit-appearance:none;
  }
  input[type=range]::-webkit-slider-thumb{
    -webkit-appearance:none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--accent);
  }

  .value{
    color: var(--accent);
    font-weight: 700;
    margin-top: 6px;
  }

  audio{
    width:100%;
    margin-top: 12px;
    border-radius: 10px;
  }

  .note{
    font-size: 12px;
    color: var(--muted);
    line-height: 1.4;
    text-align:center;
    margin-top: 8px;
  }

  /* 円と指示文のレイアウト：重ならないように余白を確保 */
  .visual{
    margin-top: 16px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap: 14px; /* ここが効く：円が大きくなっても文字に被りにくい */
  }

  #circle{
    width: 170px;
    height: 170px;
    border-radius: 50%;
    background: var(--accent);
    box-shadow: 0 0 40px rgba(56,189,248,.45);
    transform: scale(1);
    opacity: .92;

    transition-property: transform, opacity;
    transition-timing-function: linear;
  }

  #instruction{
    text-align:center;
    font-size: 20px;
    min-height: 30px;
    font-weight: 600;
  }

  .controls{
    margin-top: 16px;
    display:flex;
    justify-content:space-between;
    gap: 12px;
  }

  button{
    width: 50%;
    padding: 12px;
    border: none;
    border-radius: 24px;
    font-size: 16px;
    cursor: pointer;
    color: white;
    transition: transform .15s ease;
  }
  button:hover{ transform: scale(1.03); }

  #start{
    background: linear-gradient(45deg, var(--start1), var(--start2));
  }
  #stop{
    background: linear-gradient(45deg, var(--stop1), var(--stop2));
  }

  .divider{
    height: 1px;
    background: rgba(255,255,255,.18);
    margin: 14px 0;
  }
</style>
</head>

<body>
  <div class="container">
    <h1>呼吸瞑想アプリ</h1>

    <!-- テーマ選択 -->
    <div class="row">
      <label for="themeSelect">テーマ</label>
      <select id="themeSelect">
        <option value="aurora" selected>オーロラ（青紫）</option>
        <option value="sunset">サンセット（橙ピンク）</option>
        <option value="forest">フォレスト（深緑）</option>
      </select>
    </div>

    <div class="divider"></div>

    <!-- メトロノーム -->
    <div class="row">
      <label for="metroOn">秒カウント（メトロノーム）</label>
      <input id="metroOn" type="checkbox" checked />
    </div>
    <div class="row">
      <label for="metroVol">メトロノーム音量</label>
      <input id="metroVol" type="range" min="0" max="100" value="35" />
    </div>

    <div class="divider"></div>

    <!-- 呼吸秒数 -->
    <div class="settings">
      <div>
        <label for="inhale">吸う（秒）</label>
        <!-- 中央=6 -->
        <input id="inhale" type="range" min="2" max="10" value="6" />
        <div class="value" id="inhaleVal">6秒</div>
      </div>
      <div>
        <label for="exhale">吐く（秒）</label>
        <!-- 中央=8 -->
        <input id="exhale" type="range" min="4" max="12" value="8" />
        <div class="value" id="exhaleVal">8秒</div>
      </div>
    </div>

    <!-- BGM -->
    <audio id="bgm" src="music/bgm.mp3" preload="auto" controls></audio>

    <div class="note">
      合図音：低い音＝吸う/吐く　高い音2回＝息を止める（2秒）
    </div>
    <div class="note">
      BGM：優しい灯火 (Tenderly glow) / 蒲鉾さちこ（DOVA-SYNDROME）
    </div>

    <!-- ビジュアル -->
    <div class="visual">
      <div id="circle"></div>
      <div id="instruction">準備ができたら開始を押してください</div>
    </div>

    <div class="controls">
      <button id="start">開始</button>
      <button id="stop">停止</button>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const inhale = document.getElementById("inhale");
  const exhale = document.getElementById("exhale");
  const inhaleVal = document.getElementById("inhaleVal");
  const exhaleVal = document.getElementById("exhaleVal");
  const circle = document.getElementById("circle");
  const instruction = document.getElementById("instruction");
  const bgm = document.getElementById("bgm");

  const themeSelect = document.getElementById("themeSelect");
  const metroOn = document.getElementById("metroOn");
  const metroVol = document.getElementById("metroVol");

  let running = false;
  let timer = null;
  let metroTimer = null;

  // ---- 秒数表示
  function updateValues(){
    inhaleVal.textContent = inhale.value + "秒";
    exhaleVal.textContent = exhale.value + "秒";
  }
  inhale.addEventListener("input", updateValues);
  exhale.addEventListener("input", updateValues);
  updateValues();

  // ---- テーマ適用（CSS変数差し替え）
  const themes = {
    aurora: {
      bg1:"#667eea", bg2:"#764ba2", card:"rgba(255,255,255,.15)",
      accent:"#38bdf8",
      start1:"#22c55e", start2:"#16a34a",
      stop1:"#6b7280", stop2:"#4b5563",
      shadow:"rgba(0,0,0,.30)"
    },
    sunset: {
      bg1:"#ff6a88", bg2:"#ff9a44", card:"rgba(0,0,0,.18)",
      accent:"#ffe08a",
      start1:"#0ea5e9", start2:"#2563eb",
      stop1:"#7c3aed", stop2:"#4c1d95",
      shadow:"rgba(0,0,0,.33)"
    },
    forest: {
      bg1:"#0f766e", bg2:"#064e3b", card:"rgba(255,255,255,.12)",
      accent:"#a7f3d0",
      start1:"#f59e0b", start2:"#d97706",
      stop1:"#374151", stop2:"#111827",
      shadow:"rgba(0,0,0,.35)"
    }
  };

  function applyTheme(key){
    const t = themes[key] || themes.aurora;
    const r = document.documentElement.style;
    r.setProperty("--bg1", t.bg1);
    r.setProperty("--bg2", t.bg2);
    r.setProperty("--card", t.card);
    r.setProperty("--accent", t.accent);
    r.setProperty("--start1", t.start1);
    r.setProperty("--start2", t.start2);
    r.setProperty("--stop1", t.stop1);
    r.setProperty("--stop2", t.stop2);
    r.setProperty("--shadow", t.shadow);
  }
  themeSelect.addEventListener("change", () => applyTheme(themeSelect.value));
  applyTheme(themeSelect.value);

  // ---- 音（合図音＋メトロノーム）
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  function ensureAudio(){
    if (audioCtx.state === "suspended") {
      audioCtx.resume().catch(()=>{});
    }
  }

  // ウッドブロック風（短くて埋もれにくい）
  function wood(freq = 300, duration = 0.11, gainPeak = 0.35){
    ensureAudio();
    const now = audioCtx.currentTime;

    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    const filter = audioCtx.createBiquadFilter();

    osc.type = "square";
    osc.frequency.value = freq;

    filter.type = "bandpass";
    filter.frequency.value = Math.min(2400, freq * 3);

    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(gainPeak, now + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, now + duration);

    osc.connect(filter);
    filter.connect(g);
    g.connect(audioCtx.destination);

    osc.start(now);
    osc.stop(now + duration);
  }

  // メトロノーム：1秒ごとに「軽いクリック」、フェーズ開始時は少し強め
  function metroClick(accent = false){
    const vol = Math.max(0, Math.min(1, parseInt(metroVol.value, 10) / 100));
    if (vol === 0) return;
    // 周波数は固定で、アクセントは音量を上げる
    wood(520, 0.05, accent ? (0.10 + vol * 0.45) : (0.07 + vol * 0.28));
  }

  function startMetronome(){
    stopMetronome();
    if (!metroOn.checked) return;

    // すぐ1回鳴らして、以降1秒ごと
    metroClick(true);
    metroTimer = setInterval(() => metroClick(false), 1000);
  }

  function stopMetronome(){
    if (metroTimer) {
      clearInterval(metroTimer);
      metroTimer = null;
    }
  }

  // ---- 呼吸フェーズ
  // 要件：吸う / 止める(2秒) / 吐く / 止める(2秒)
  const HOLD_MS = 2000;

  // 円が文字に被らないよう最大値を抑制（ここを調整ポイントとして明示）
  const SCALE_INHALE_MAX = 1.25; // ←最大化を抑える（1.35などに上げると被りやすい）
  const SCALE_EXHALE_MIN = 0.78;

  function setPhase(text, durationMs, scale, opacity){
    instruction.textContent = text;
    circle.style.transitionDuration = durationMs + "ms";
    circle.style.transform = `scale(${scale})`;
    circle.style.opacity = String(opacity);
  }

  function cueInhale(){ wood(300); }              // 低い音：吸う
  function cueExhale(){ wood(220); }              // 低い音：吐く（さらに低い）
  function cueHold(){
    wood(900); setTimeout(() => wood(900), 150);  // 高い音2回：止める
  }

  function cycle(){
    if (!running) return;

    const inhaleMs = parseInt(inhale.value, 10) * 1000;
    const exhaleMs = parseInt(exhale.value, 10) * 1000;

    // 吸う
    cueInhale();
    setPhase("吸って", inhaleMs, SCALE_INHALE_MAX, 1.0);
    startMetronome(); // 秒カウント開始（フェーズ開始のアクセント含む）

    timer = setTimeout(() => {
      // 止める
      cueHold();
      setPhase("止める", HOLD_MS, SCALE_INHALE_MAX, 0.86);
      startMetronome();

      timer = setTimeout(() => {
        // 吐く
        cueExhale();
        setPhase("吐いて", exhaleMs, SCALE_EXHALE_MIN, 1.0);
        startMetronome();

        timer = setTimeout(() => {
          // 止める
          cueHold();
          setPhase("止める", HOLD_MS, 0.92, 0.70);
          startMetronome();

          timer = setTimeout(() => {
            cycle();
          }, HOLD_MS);

        }, exhaleMs);

      }, HOLD_MS);

    }, inhaleMs);
  }

  function start(){
    if (running) return;
    running = true;
    ensureAudio();

    bgm.play().catch(()=>{ /* 手動再生でもOK */ });

    // 初期状態を整える
    circle.style.transform = "scale(1)";
    circle.style.opacity = "0.92";

    cycle();
  }

  function stop(){
    running = false;
    if (timer) clearTimeout(timer);
    timer = null;
    stopMetronome();

    instruction.textContent = "停止しました";
    circle.style.transitionDuration = "250ms";
    circle.style.transform = "scale(1)";
    circle.style.opacity = "0.92";
    bgm.pause();
  }

  document.getElementById("start").addEventListener("click", start);
  document.getElementById("stop").addEventListener("click", stop);
});
</script>
</body>
</html>
