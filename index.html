function initThemeSelect(){
  if (!themeSelect) return;

  themeSelect.innerHTML = "";

  // カテゴリごとに optgroup を作る（カテゴリ名は見出しにだけ表示）
  const groups = new Map(); // key: category, value: optgroup
  for (const t of THEMES){
    const cat = t.category || "Other";

    if (!groups.has(cat)){
      const og = document.createElement("optgroup");

      // ★カテゴリ見出し（ここだけにカテゴリ名を出す）
      // 例: "Calm / 癒し（やわらかい・落ち着く）"
      // breathingアプリ側で categoryLabel を持っているならそれを優先
      og.label = t.categoryLabel || cat;

      groups.set(cat, og);
      themeSelect.appendChild(og);
    }

    const opt = document.createElement("option");
    opt.value = t.id;

    // ★重複していたカテゴリ名は付けない（短い表示だけ）
    // 例: "癒し：ミスト" / "癒し：サンド"
    // もし t.label が長い場合は「最後の区切り以降」だけ残す
    opt.textContent = getShortThemeLabel(t.label);

    groups.get(cat).appendChild(opt);
  }

  // 初期値（保存がなければ calm_mist）
  let saved = "calm_mist";
  try { saved = localStorage.getItem("pomo_theme_v2") || saved; } catch(e) {}

  if (!THEMES.some(t => t.id === saved)) saved = THEMES[0]?.id || "calm_mist";
  themeSelect.value = saved;
  applyTheme(saved);

  themeSelect.addEventListener("change", () => {
    const id = themeSelect.value;
    applyTheme(id);
    try { localStorage.setItem("pomo_theme_v2", id); } catch(e) {}
  });
}

// ----------------------------
// ★短いラベルにする（保険）
// "Calm / 癒し（...） / 癒し：ミスト" → "癒し：ミスト"
// "Calm｜癒し：ミスト" → "癒し：ミスト"
// すでに短ければそのまま
function getShortThemeLabel(label){
  if (!label) return "";

  // スラッシュ区切りがあるなら最後だけ
  if (label.includes(" / ")){
    return label.split(" / ").pop().trim();
  }

  // 「｜」があるなら右側だけ
  if (label.includes("｜")){
    return label.split("｜").pop().trim();
  }

  // それ以外はそのまま
  return label.trim();
}
